name: Deploy Foodgram

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/foodgram_backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build frontend
      run: |
        cd frontend
        npm ci --legacy-peer-deps
        GENERATE_SOURCEMAP=false CI=false npm run build
    
    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/foodgram_frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    
    - name: Deploy to server
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Ð¸ Docker Compose ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
          if ! command -v docker &> /dev/null; then
            echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            rm get-docker.sh
          fi
          
          if ! command -v docker-compose &> /dev/null; then
            echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          PROJECT_DIR="/home/${{ secrets.USERNAME }}/foodgram"
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ
          sudo rm -rf $PROJECT_DIR
          mkdir -p $PROJECT_DIR
          cd $PROJECT_DIR
          
          # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
          git clone https://github.com/${{ github.repository }}.git .
          
          # Ð”ÐµÐ»Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          sudo chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} $PROJECT_DIR
          
          cd infra
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
          cat > .env << EOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.DOMAIN_NAME }},www.${{ secrets.DOMAIN_NAME }},localhost,127.0.0.1
          DB_ENGINE=django.db.backends.postgresql
          DB_NAME=${{ secrets.DB_NAME }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          EOF
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ñ Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð¼
          sed -i 's/your-domain.com/${{ secrets.DOMAIN_NAME }}/g' nginx.simple.conf
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          docker-compose -f docker-compose.prod.yml pull
          docker-compose -f docker-compose.prod.yml up -d --build
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          sleep 30
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py load_ingredients_data
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py load_tags_data
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py shell -c "
          from django.contrib.auth import get_user_model
          User = get_user_model()
          if not User.objects.filter(email='admin@foodgram.com').exists():
              User.objects.create_superuser('admin', 'admin@foodgram.com', 'admin123')
              print('Ð¡ÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½: admin@foodgram.com / admin123')
          else:
              print('Ð¡ÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚')
          "
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          docker system prune -f
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          docker-compose -f docker-compose.prod.yml ps
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://${{ secrets.DOMAIN_NAME }}"
          echo "ðŸ‘¤ ÐÐ´Ð¼Ð¸Ð½ÐºÐ°: http://${{ secrets.DOMAIN_NAME }}/admin/"
          echo "   Ð›Ð¾Ð³Ð¸Ð½: admin@foodgram.com"
          echo "   ÐŸÐ°Ñ€Ð¾Ð»ÑŒ: admin123"
          echo ""
          echo "ðŸ“š API Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://${{ secrets.DOMAIN_NAME }}/api/docs/"
          echo ""
          echo "âš ï¸  Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°:"
          echo "   1. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð´Ð¾Ð¼ÐµÐ½ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
          echo "   2. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: sudo certbot --nginx -d ${{ secrets.DOMAIN_NAME }}"
          echo "   3. Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ nginx.simple.conf Ð½Ð° nginx.prod.conf Ð² docker-compose"
